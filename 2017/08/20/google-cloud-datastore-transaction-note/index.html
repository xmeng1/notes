<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="blog,develop,objectify," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="摘要：Datastore 作为 NoSQL，虽然支持 Transaction，但是在使用中需要有些注意。本文记录了使用 Objectify 来使用 Datastore 的 Transaction 功能 的注意事项。">
<meta name="keywords" content="blog,develop,objectify">
<meta property="og:type" content="article">
<meta property="og:title" content="Google Cloud Datastore Transaction 使用注意事项">
<meta property="og:url" content="https://notes.mengxin.science/2017/08/20/google-cloud-datastore-transaction-note/index.html">
<meta property="og:site_name" content="Xin&#39;s Notes">
<meta property="og:description" content="摘要：Datastore 作为 NoSQL，虽然支持 Transaction，但是在使用中需要有些注意。本文记录了使用 Objectify 来使用 Datastore 的 Transaction 功能 的注意事项。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-12-21T09:52:36.028Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Google Cloud Datastore Transaction 使用注意事项">
<meta name="twitter:description" content="摘要：Datastore 作为 NoSQL，虽然支持 Transaction，但是在使用中需要有些注意。本文记录了使用 Objectify 来使用 Datastore 的 Transaction 功能 的注意事项。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'LRRR8WO27T',
      apiKey: '52f38cdd494149d36c3b9a986a36836c',
      indexName: 'prod_notes',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://notes.mengxin.science/2017/08/20/google-cloud-datastore-transaction-note/"/>





  <title> Google Cloud Datastore Transaction 使用注意事项 | Xin's Notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-40931165-6', 'auto');
  ga('send', 'pageview');
</script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xin's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">Develop Notes</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<div id="google_translate_element"></div><script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'zh-CN', layout: google.translate.TranslateElement.InlineLayout.SIMPLE, multilanguagePage: true, gaTrack: true, gaId: 'UA-40931165-7'}, 'google_translate_element');
}
</script><script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://notes.mengxin.science/2017/08/20/google-cloud-datastore-transaction-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xin Meng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar-2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xin's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                Google Cloud Datastore Transaction 使用注意事项
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-20T23:00:00+00:00">
                2017-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/知识积累/" itemprop="url" rel="index">
                    <span itemprop="name">知识积累</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/20/google-cloud-datastore-transaction-note/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/08/20/google-cloud-datastore-transaction-note/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>摘要：<code>Datastore</code> 作为 <code>NoSQL</code>，虽然支持 <code>Transaction</code>，但是在使用中需要有些注意。本文记录了使用 <code>Objectify</code> 来使用 <code>Datastore</code> 的 <code>Transaction</code> 功能 的注意事项。</p>
<a id="more"></a>
<h2 id="什么是事务-Transaction"><a href="#什么是事务-Transaction" class="headerlink" title="什么是事务 Transaction"></a>什么是事务 <code>Transaction</code></h2><blockquote>
<p>A transaction is an operation or set of operations that is atomic—either all of the operations in the transaction occur, or none of them occur. An application can perform multiple operations and calculations in a single transaction.</p>
</blockquote>
<p>事务就是一个或一组原子性操作，这组操作要不就全部都执行，要不就都不执行，不存在部分执行的情况。</p>
<p>一般事务包含有四种特性，简称为 ACID 特性：</p>
<ol>
<li><strong>原子性</strong>（<strong>Atomicity</strong>）：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。</li>
<li><strong>一致性</strong>（<strong>Consistency</strong>）：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。</li>
<li><strong>隔离性</strong>（<strong>Isolation</strong>）：多个事务并发执行时，一个事务的执行不应影响其他事务的执行。</li>
<li><strong>持久性</strong>（<strong>Durability</strong>）：已被提交的事务对数据库的修改应该永久保存在数据库中。</li>
</ol>
<h2 id="Datastore-事务概述"><a href="#Datastore-事务概述" class="headerlink" title="Datastore 事务概述"></a><code>Datastore</code> 事务概述</h2><p>Datastore 支持事务操作，同时需要了解其限制为最长 <strong>60s</strong> 以及在 <strong>30s 后</strong>，如果有 <strong>10s 的闲置</strong>则就会过期。</p>
<blockquote>
<p>Transactions have a maximum duration of 60 seconds with a 10 second idle expiration time after 30 seconds.</p>
</blockquote>
<p>另外还有某些情况下会失败</p>
<blockquote>
<p>An operation might fail when:</p>
<ol>
<li>Too many concurrent modifications are attempted on the same entity group. </li>
<li>The transaction exceeds a resource limit. </li>
<li>Cloud Datastore encounters an internal error.</li>
</ol>
</blockquote>
<h2 id="Entity-Group"><a href="#Entity-Group" class="headerlink" title="Entity Group"></a>Entity Group</h2><p>Datastore 中的 Entity Group 是和事务息息相关的一个概念，因为这个限制了在事务中允许的操作。</p>
<p>我们把 Entity 成为实体，也就是在 Datastore 的数据项，形象的表示就是表示一种数据的一张数据表，比如 用户实体，Entity 就是 User，类似于 关系型数据库的一张表或者是数据库 E-R 图中的 E （Entity）类似。</p>
<p>所谓 Entity Group 就是， 实体组。因为 NoSQL 没有关系型数据库中的 R，所以 Datastore 使用了一个 Parent 来将实体组织成一种父子的层级关系。实体组就是 一组实体，他们线性依赖的一组实体 A-&gt;B-&gt;C…。</p>
<h3 id="Datastore-事务关于-Entity-Group-的限制"><a href="#Datastore-事务关于-Entity-Group-的限制" class="headerlink" title="Datastore 事务关于 Entity Group 的限制"></a>Datastore 事务关于 Entity Group 的限制</h3><blockquote>
<p>All the data accessed by a transaction must be contained in at most 25 entity groups.</p>
<p>If you want to use queries within a transaction, your data must be organized into entity groups in such a way that you can specify ancestor filters that will match the right data.</p>
<p>There is a write throughput limit of about one transaction per second within a single entity group. This limitation exists because Cloud Datastore performs masterless, synchronous replication of each entity group over a wide geographic area to provide high reliability and fault tolerance.</p>
</blockquote>
<p>为什么会有这些限制呢？ 我们思考一下最为 Google 的轻量级NoSQL的数据存储实际上支持强一致性的无主节点的完全分布式是一个非常吸引人的特性。要知道对于分布式数据库的强一致性不是非常容易实现的，而 Datastore 支持这种强一致性，必然会带来限制。我们可以先了解一下 Google Datastore 对于 Entity Group 是如何存储的：</p>
<blockquote>
<p>Entity group relationships tell App Engine to store several entities in the same part of the distributed network.</p>
</blockquote>
<p>也就是说这样一组实体会被存储在相同的分布式网络。这也是强一致性的基础，因为强一致性需要进行大量的同步操作（比如 Paxos一致性协议），从带来带宽和网络的负载。所以 Google 不可能允许无限制的进行强一致性的事务操作，而是限制了25个组，这样应该有效的减少跨区域网络的带宽压力。至于为什么是25个，应该是 Google 根据现有的能力而定义的一个阈值。</p>
<h2 id="如何处理并发冲突"><a href="#如何处理并发冲突" class="headerlink" title="如何处理并发冲突"></a>如何处理并发冲突</h2><blockquote>
<p>When a transaction starts, Google Cloud Datastore uses <a href="https://wikipedia.org/wiki/Optimistic_concurrency_control" target="_blank" rel="noopener">optimistic concurrency control</a> by checking the last update time for the entity groups used in the transaction. Upon commiting a transaction for the entity groups, Google Cloud Datastore again checks he last update time for the entity groups used in the transaction. If it has hanged since the initial check, an exception is thrown .</p>
</blockquote>
<p>我们简单介绍一下上面 Optimistic Concurrency Control （OCC）的逻辑</p>
<ol>
<li><strong>Begin</strong>：首先记录事务开始的时间戳</li>
<li><strong>Modify</strong>：开始执行事务操作，包括读取数据库值以及修改变更</li>
<li><strong>Validate</strong>：最后进行校验，校验的内容包括其他事务操作进行了修改，同时本事务也使用了的数据。范围包含在本次事务开始后完成的事务。</li>
<li><strong>Commit/Rollback</strong>：如果有冲突或者中间有失败则需要解决，一般就是回滚重试。没有冲突就需要进行提交完成所有操作。</li>
</ol>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><h3 id="保证所有操作全部执行否则都不执行"><a href="#保证所有操作全部执行否则都不执行" class="headerlink" title="保证所有操作全部执行否则都不执行"></a>保证所有操作全部执行否则都不执行</h3><p>比如我们创建 User 的同时为 User 创建一个 Setting，如果 Setting 创建失败，则 User 也不能创建，需要整个过程重试。</p>
<p>这时候两个创建的操作就应该在一个事务中。</p>
<h3 id="保证操作整个过程中涉及的数据不会变更"><a href="#保证操作整个过程中涉及的数据不会变更" class="headerlink" title="保证操作整个过程中涉及的数据不会变更"></a>保证操作整个过程中涉及的数据不会变更</h3><p>比如我们在用户注册的时候，需要验证用户名是否在系统中唯一，如果不唯一需要提示错误，但是如果两个用户几乎同时注册，前一个注册验证成功，但是还没有最后在数据库写入数据的过程中，另一个用户也开始用相同用户名注册，这时候也会验证，因为上一个还没写入数据，所以也会验证成功。这时候实际上就出现冲突。</p>
<p>我们需要将注册的流程的查询操作和创建操作放在一个事务中，这样在后一个用户注册虽然验证成功了，但是在创建用户后开始提交事务，将会发现用户数据库表发生了变化，这样也就影响了验证操作的结果，所以事务操作将会失败，需要重试。（这里按常理假设第一个注册的用户的流程在第二个注册流程过程已经完成提交事务，当然如何反过来同样，只不过变成第一个事务失败）</p>
<h2 id="使用-Objectify-进行事务操作"><a href="#使用-Objectify-进行事务操作" class="headerlink" title="使用 Objectify 进行事务操作"></a>使用 Objectify 进行事务操作</h2><p>大部分人在进行 Datastore 的操作中一般都会选用  Objectify。该库提供了更加友好的使用 Transaction 的接口，比如可以使用 Guice 通过注解来实现方法的事务化。<br>我们这里首先列出若干使用的问题</p>
<h3 id="不要在事务中进行无-ancestor-的查询"><a href="#不要在事务中进行无-ancestor-的查询" class="headerlink" title="不要在事务中进行无 ancestor 的查询"></a>不要在事务中进行无 <code>ancestor</code> 的查询</h3><p>这个是 Datastore 的要求，如果希望在事务中进行查询，必须带有 <code>ancestor</code>。</p>
<h3 id="如果进行非事务的查询，可以使用transactionless"><a href="#如果进行非事务的查询，可以使用transactionless" class="headerlink" title="如果进行非事务的查询，可以使用transactionless"></a>如果进行非事务的查询，可以使用<code>transactionless</code></h3><p>这个方法提供不少方便，但是需要自行确定这个查询操作不会受到其他事务的影响，因为这个操作不会被事务进行检查。比如我们上面提到的那个注册的例子就不能用这个方法。</p>
<h3 id="事务中进行查询需要查询内容的创建时间"><a href="#事务中进行查询需要查询内容的创建时间" class="headerlink" title="事务中进行查询需要查询内容的创建时间"></a>事务中进行查询需要查询内容的创建时间</h3><p>如果数据是在事务过程中创建的，是无法通过普通的查询语句查出来的，因为在事物的过程中，实际数据并没有真正的写入数据库。所有如果需要使用在事务过程中创建的数据需要在程序中记录创建后的 Key，然后直接通过 Key 来获取数据本身。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/blog/" rel="tag"># blog</a>
          
            <a href="/tags/develop/" rel="tag"># develop</a>
          
            <a href="/tags/objectify/" rel="tag"># objectify</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/20/desktop-entry-on-linux-location/" rel="next" title="Linux Desktop Entry Location">
                <i class="fa fa-chevron-left"></i> Linux Desktop Entry Location
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/21/english-pod-lesson-7/" rel="prev" title="English Pod Study Note Lesson 7">
                English Pod Study Note Lesson 7 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
      
        
          <ul class="sidebar-nav motion-element">
            <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
              文章目录
            </li>
            <li class="sidebar-nav-overview" data-target="site-overview">
              站点概览
            </li>
          </ul>
        
      



      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar-2.jpg"
               alt="Xin Meng" />
          <p class="site-author-name" itemprop="name">Xin Meng</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">152</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">162</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xmeng1" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/xinmeng_1" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/michealmeng" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/xinmeng1" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-linkedin"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/mengxin.city" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/xinmeng1" target="_blank" title="Douban">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Douban
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/xinmeng1" target="_blank" title="Zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Next
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://theme-next.iissnan.com" title="Title" target="_blank">Title</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>
      
        
        <!--noindex-->
          <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
            <div class="post-toc">

              
                
              

              
                <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是事务-Transaction"><span class="nav-number">1.</span> <span class="nav-text">什么是事务 Transaction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Datastore-事务概述"><span class="nav-number">2.</span> <span class="nav-text">Datastore 事务概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Entity-Group"><span class="nav-number">3.</span> <span class="nav-text">Entity Group</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Datastore-事务关于-Entity-Group-的限制"><span class="nav-number">3.1.</span> <span class="nav-text">Datastore 事务关于 Entity Group 的限制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何处理并发冲突"><span class="nav-number">4.</span> <span class="nav-text">如何处理并发冲突</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用场景"><span class="nav-number">5.</span> <span class="nav-text">使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#保证所有操作全部执行否则都不执行"><span class="nav-number">5.1.</span> <span class="nav-text">保证所有操作全部执行否则都不执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#保证操作整个过程中涉及的数据不会变更"><span class="nav-number">5.2.</span> <span class="nav-text">保证操作整个过程中涉及的数据不会变更</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-Objectify-进行事务操作"><span class="nav-number">6.</span> <span class="nav-text">使用 Objectify 进行事务操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#不要在事务中进行无-ancestor-的查询"><span class="nav-number">6.1.</span> <span class="nav-text">不要在事务中进行无 ancestor 的查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如果进行非事务的查询，可以使用transactionless"><span class="nav-number">6.2.</span> <span class="nav-text">如果进行非事务的查询，可以使用transactionless</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务中进行查询需要查询内容的创建时间"><span class="nav-number">6.3.</span> <span class="nav-text">事务中进行查询需要查询内容的创建时间</span></a></li></ol></li></ol></div>
              

            </div>
          </section>
        <!--/noindex-->
        
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin Meng</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://mengxin.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://notes.mengxin.science/2017/08/20/google-cloud-datastore-transaction-note/';
          this.page.identifier = '2017/08/20/google-cloud-datastore-transaction-note/';
          this.page.title = 'Google Cloud Datastore Transaction 使用注意事项';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://mengxin.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  





  






  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.1"></script>



  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        },
        TeX: { equationNumbers: { autoNumber: "AMS" }}
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

</body>
</html>
